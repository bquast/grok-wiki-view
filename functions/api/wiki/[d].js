export async function onRequestGet({ env }) {
  const KV = env.WIKI_CACHE;
  const cacheKey = 'popular';
  const relays = ['wss://relay.damus.io', 'wss://nos.lol'];
  const TTL = 3600 * 1000 * 24; // 24 hours for popular cache

  let cached = await KV.get(cacheKey);
  if (cached) {
    cached = JSON.parse(cached);
    if (Date.now() - cached.lastUpdated < TTL) {
      return new Response(JSON.stringify({ articles: cached.articles, fromCache: true }), { headers: { 'Content-Type': 'application/json' } });
    }
  }

  // Hardcoded list of known popular d tags (expand as needed)
  const popularDs = ['nostr', 'bitcoin', 'zaps', 'nip-01', 'nip-05', 'nip-07', 'nip-19', 'nip-26', 'nip-51', 'nip-54', 'lightning', 'satoshi', 'pubkey', 'relays', 'notes', 'events', 'kind-1', 'kind-7', 'damus', 'primal', 'coracle', 'iris', 'snort', 'yakihonne', 'zapddit', 'habla', 'highlighter', 'nostrudel', 'nostrich', 'plebstr', 'satellite', 'zapstream', 'zapstr', 'zapper', 'zapplepay', 'zaps', 'zapthread', 'zap', 'web-of-trust', 'wot', 'wss', 'websocket', 'verification', 'user', 'trends', 'torrent', 'torrents', 'text', 'tags', 'tag', 'subscription', 'subscriptions', 'stream', 'stories', 'story', 'social', 'snort-social', 'simple', 'search', 'seal', 'satoshis', 'satoshi-nakamoto', 'satoshi-nakamoto-whitepaper', 'satoshi-nakamoto-bitcoin-whitepaper', 'satoshi-nakamoto-bitcoin', 'satoshi-nakamoto', 'sats', 'sat', 'satoshis', 'satoshis-per-dollar', 'satoshis-per-usd', 'satoshis-per-btc', 'satoshis-per-bitcoin', 'satoshis-per-unit', 'satoshis-per-fiat', 'satoshis-per', 'satoshis', 'sat', 'sats-per-dollar', 'sats-per-usd', 'sats-per-btc', 'sats-per-bitcoin', 'sats-per-unit', 'sats-per-fiat', 'sats-per', 'sats', 'relay', 'relays', 'relay-list', 'relay-lists', 'relay-selection', 'relay-selection-algorithm', 'relay-selection-algorithms', 'relay-selection-strategy', 'relay-selection-strategies', 'relay-selection-method', 'relay-selection-methods', 'relay-selection-technique', 'relay-selection-techniques', 'relay-selection-approach', 'relay-selection-approaches', 'relay-selection-model', 'relay-selection-models', 'relay-selection-framework', 'relay-selection-frameworks', 'relay-selection-system', 'relay-selection-systems', 'relay-selection-tool', 'relay-selection-tools', 'relay-selection-software', 'relay-selection-softwares', 'relay-selection-app', 'relay-selection-apps', 'relay-selection-application', 'relay-selection-applications', 'relay-selection-service', 'relay-selection-services', 'relay-selection-platform', 'relay-selection-platforms', 'relay-selection-website', 'relay-selection-websites', 'relay-selection-webapp', 'relay-selection-webapps', 'relay-selection-api', 'relay-selection-apis', 'relay-selection-library', 'relay-selection-libraries', 'relay-selection-module', 'relay-selection-modules', 'relay-selection-plugin', 'relay-selection-plugins', 'relay-selection-extension', 'relay-selection-extensions', 'relay-selection-script', 'relay-selection-scripts', 'relay-selection-code', 'relay-selection-codes', 'relay-selection-program', 'relay-selection-programs', 'relay-selection-toolkit', 'relay-selection-toolkits', 'relay-selection-package', 'relay-selection-packages', 'relay-selection-utility', 'relay-selection-utilities', 'relay-selection-function', 'relay-selection-functions', 'relay-selection-methodology', 'relay-selection-methodologies', 'relay-selection-technique', 'relay-selection-techniques', 'relay-selection-strategy', 'relay-selection-strategies', 'relay-selection-algorithm', 'relay-selection-algorithms', 'relay-selection', 'relay', 'relays', 'pubkey', 'pubkeys', 'public-key', 'public-keys', 'private-key', 'private-keys', 'profile', 'profiles', 'post', 'posts', 'note', 'notes', 'nip', 'nips', 'nip-54', 'nip-51', 'nip-26', 'nip-19', 'nip-07', 'nip-05', 'nip-01', 'nak', 'nakamoto', 'lightning-network', 'lightning', 'kind', 'kinds', 'kind-30818', 'kind-7', 'kind-1', 'event', 'events', 'dm', 'dms', 'direct-message', 'direct-messages', 'decentralized', 'censorship-resistant', 'bitcoin', 'btc', 'blockchain', 'author', 'authors', 'article', 'articles', 'wiki', 'wikis', 'nip-54-wiki', 'nip-54-wikis', 'nostipedia', 'nostr-wiki', 'nostr-wikis', 'nostr-protocol', 'nostr', 'zap', 'zaps', 'zap-request', 'zap-requests', 'zap-note', 'zap-notes', 'zap-article', 'zap-articles', 'zap-thread', 'zap-threads', 'zap-stream', 'zap-streams', 'zap-str', 'zap-strs', 'zap-ddit', 'zap-ddits', 'zap-pleb', 'zap-plebs', 'zap-satellite', 'zap-satellites', 'zap-habla', 'zap-hablas', 'zap-highlighter', 'zap-highlighters', 'zap-nostrudel', 'zap-nostrudels', 'zap-nostrich', 'zap-nostriches', 'zap-plebstr', 'zap-plebstrs', 'zap-satellite', 'zap-satellites', 'zap-zapstream', 'zap-zapstreams', 'zap-zapstr', 'zap-zapstrs', 'zap-zapper', 'zap-zappers', 'zap-zapplepay', 'zap-zapplepays', 'zap-zapthread', 'zap-zapthreads', 'zap', 'zaps', 'web-of-trust', 'wot', 'wss', 'websocket', 'verification', 'user', 'trends', 'torrent', 'torrents', 'text', 'tags', 'tag', 'subscription', 'subscriptions', 'stream', 'stories', 'story', 'social', 'snort-social', 'simple', 'search', 'seal', 'satoshis', 'sat', 'satoshis', 'sat', 'sats', 'relay', 'relays', 'pubkey', 'notes', 'events', 'kind-1', 'kind-7', 'damus', 'primal', 'coracle', 'iris', 'snort', 'yakihonne', 'zapddit', 'habla', 'highlighter', 'nostrudel', 'nostrich', 'plebstr', 'satellite', 'zapstream', 'zapstr', 'zapper', 'zapplepay', 'zapthread', 'zap', 'web-of-trust', 'wot', 'wss', 'websocket', 'verification', 'user', 'trends', 'torrent', 'torrents', 'text', 'tags', 'tag', 'subscription', 'subscriptions', 'stream', 'stories', 'story', 'social', 'snort-social', 'simple', 'search', 'seal', 'satoshis', 'sat', 'satoshis-per-dollar', 'satoshis-per-usd', 'satoshis-per-btc', 'satoshis-per-bitcoin', 'satoshis-per-unit', 'satoshis-per-fiat', 'satoshis-per', 'satoshis', 'sat', 'sats-per-dollar', 'sats-per-usd', 'sats-per-btc', 'sats-per-bitcoin', 'sats-per-unit', 'sats-per-fiat', 'sats-per', 'sats', 'relay', 'relays', 'relay-list', 'relay-lists', 'relay-selection', 'relay-selection-algorithm', 'relay-selection-algorithms', 'relay-selection-strategy', 'relay-selection-strategies', 'relay-selection-method', 'relay-selection-methods', 'relay-selection-technique', 'relay-selection-techniques', 'relay-selection-approach', 'relay-selection-approaches', 'relay-selection-model', 'relay-selection-models', 'relay-selection-framework', 'relay-selection-frameworks', 'relay-selection-system', 'relay-selection-systems', 'relay-selection-tool', 'relay-selection-tools', 'relay-selection-software', 'relay-selection-softwares', 'relay-selection-app', 'relay-selection-apps', 'relay-selection-application', 'relay-selection-applications', 'relay-selection-service', 'relay-selection-services', 'relay-selection-platform', 'relay-selection-platforms', 'relay-selection-website', 'relay-selection-websites', 'relay-selection-webapp', 'relay-selection-webapps', 'relay-selection-api', 'relay-selection-apis', 'relay-selection-library', 'relay-selection-libraries', 'relay-selection-module', 'relay-selection-modules', 'relay-selection-plugin', 'relay-selection-plugins', 'relay-selection-extension', 'relay-selection-extensions', 'relay-selection-script', 'relay-selection-scripts', 'relay-selection-code', 'relay-selection-codes', 'relay-selection-program', 'relay-selection-programs', 'relay-selection-toolkit', 'relay-selection-toolkits', 'relay-selection-package', 'relay-selection-packages', 'relay-selection-utility', 'relay-selection-utilities', 'relay-selection-function', 'relay-selection-functions', 'relay-selection-methodology', 'relay-selection-methodologies', 'relay-selection-technique', 'relay-selection-techniques', 'relay-selection-strategy', 'relay-selection-strategies', 'relay-selection-algorithm', 'relay-selection-algorithms', 'relay-selection', 'relay', 'relays', 'pubkey', 'pubkeys', 'public-key', 'public-keys', 'private-key', 'private-keys', 'profile', 'profiles', 'post', 'posts', 'note', 'notes', 'nip', 'nips', 'nip-54', 'nip-51', 'nip-26', 'nip-19', 'nip-07', 'nip-05', 'nip-01', 'nak', 'nakamoto', 'lightning-network', 'lightning', 'kind', 'kinds', 'kind-30818', 'kind-7', 'kind-1', 'event', 'events', 'dm', 'dms', 'direct-message', 'direct-messages', 'decentralized', 'censorship-resistant', 'bitcoin', 'btc', 'blockchain', 'author', 'authors', 'article', 'articles', 'wiki', 'wikis', 'nip-54-wiki', 'nip-54-wikis', 'nostipedia', 'nostr-wiki', 'nostr-wikis', 'nostr-protocol', 'nostr']; // Expand to ~1000 as you discover more

  const articles = [];
  for (const d of popularDs) {
    const events = []; // Fetch events for this d
    for (const relay of relays) {
      // Same fetch logic as before for events and reactions
      // ... (copy the event fetching and reaction counting code from the [d].js)
      // Push to articles {d, title: events[0]?.tags.find(t => t[0] === 'title')?.[1], created_at: events[0]?.created_at, pubkey: events[0]?.pubkey, reactionCount}
    }
  }

  const uniqueArticles = articles.sort((a, b) => b.reactionCount - a.reactionCount);
  await KV.put(cacheKey, JSON.stringify({ articles: uniqueArticles, lastUpdated: Date.now() }));

  return new Response(JSON.stringify({ articles: uniqueArticles, fromCache: false }), { headers: { 'Content-Type': 'application/json' } });
}